# 클러스터 아키텍쳐

쿠버네티스 클러스터는 `컨트롤 플레인`(마스터 노드)와 노드라 불리는 `워커 머신`(워커 노드)로 구성되어 있다.

이 노드들은 컨테이너화된 애플리케이션을 실행하며, 모든 클러스터는 파드를 실행하기 위해 최소한 하나 이상의 노드를 필요로 한다.

워커 노드는 `애플리케이션 워크로드의 구성 요소`인 파드를 호스팅한다. 컨트롤 플레인은 클러스터 내 워커 노드와 파드를 관리한다. 프로덕션 환경에서 컨트롤 플레인은 보통 여러 대의 컴퓨터에서 실행되며, 장애 허용성과 고가용성(HA)를 제공한다.

![alt text](./images/cluster_architecture.png.png)

## 컨트롤 플레인 컴포넌트

클러스터에 대한 전역적인 결정뿐만 아니라, 이벤트를 감지하고 대응한다.

컨트롤 플레인 컴포넌트는 클러스터 안 어떤 머신에서도 실행 가능은 하다.

### kube-apiserver
쿠버네티스 API를 노출하는 `컨트롤 플레인 컴포넌트`이다. API 서버를 쿠버네티스의 프론트엔드로 표현했다.

쿠버네티스 API 서버의 주요 구현은 `kube-apiserver`이다. kube-apiserver는 `수평 확장`되도록 디자인되어 더 많은 인스턴스를 통해 배포를 확장할 수 있다.

### etcd
모든 클러스터 데이터를 담는 쿠버네티스 뒷단의 저장소이다. 일관성, 고가용성의 키-밸류 저장소이다.

### kube-scheduler
노드가 배정되지 않은 새로운 파드를 감지, 실행해줄 노드를 선택하는 `컨트롤 플레인 컴포넌트`이다.

결정을 위해서
- 리소스에 대한 개별 및 총체적 요구 사항
- 하드웨어/소프트웨어 정책적 계약
- 어피니티(affinity, 유연) 및 안티-어피니티 명세
- 데이터 지역성
- 워크로드 간 간섭
- 데드라인
을 고려한다.

### kube-controller-manager
컨트롤러 프로세스를 실행하는 컨트롤 플레인 컴포넌트이다.

각 컨트롤러는 논리적으로 분리된 프로세스이지만, 복잡성을 위해 모두 단일 바이너리(애플리케이션이나 시스템의 모든 코드와 실행에 필요한 기능을 하나의 실행 파일 안에 통합한 형태)로 컴파일된 후 단일 프로세스 내에서 실행된다.

- 노드 컨트롤러: 노드의 다운을 감지하고 대응한다.
- 잡 컨트롤러: 일회성 작업을 표현하는 잡(job) 오브젝트를 감시, 수행을 위한 파드를 생성한다.
- 엔드포인트슬라이드 컨트롤라: 파드와 서비스 사이의 연결을 제공한다.
- 서비스어카운트 컨트롤러: 신규 네임스페이스에 기본 서비스어카운트를 생성한다.
- ..기타 등등..

### 클라우드 컨트롤러 매니저
클라우드별 컨트롤 로직을 포함하는 컨트롤 플레인 컴포넌트이다. 이를 통해 클라우드 공급자 API에 클러스터를 연결하고 해당 `클라우드 플랫폼과 상호작용`하는 `컴포넌트`와 `클러스터와만 상호작용`하는 `컴포넌트`를 `구분`할 수 있게 해준다.

쿠버네티스를 온프레미스 또는 개인 PC에서 실행하는 경우에는 클라우드 컨트롤러 매니저가 없다.

`kube-controller-manager`와 마찬가지로, 단일 바이너리로 결합해 단일 프로세스로 실행한다. 수평 확장을 할 수 없다.

`클라우드 공급자 의존성을 가질 수 있는 컨트롤러`
- 노드 컨트롤러: 노드 응답이 멈춘 뒤, 클라우드에서 해당 노드가 삭제되었는지를 판단하기 위해
- 라우트 컨트롤러: 클라우드 인프라 기반에서 라우트 설정
- 서비스 컨트롤러: 클라우드 공급자의 로드 밸런서 C,U,D

## 노드 컴포넌트

### kubelet
클러스터의 `각 노드에서 실행`되며 `파드를 유지`하고 `쿠버네티스 런타임 환경`을 제공한다.

제공된 `파드 스펙의 집합을 받아` 컨테이너가 `해당 파드 스펙에 따라 건강하게` 동작하는 것을 확실히 한다.

### kube-proxy (선택 사항)
난 노드에서 실행되는 네트워크 프록시이다. `서비스` 개념의 구현부.

`노드의 네트워크 규칙을 관리`한다. 이 규칙은 내부 네트워크 세션이나 클러스터 외부에서 파드로의 통신을 할 수 있게 해준다.

운영체제에 가용한 패킷 필터링 계층이 있으면 그걸 사용하며, 없는 경우 트래픽 자체를 포워드한다.

서비스에 대한 패킷 포워딩을 자체적으로 구현하며 kube-proxy와 동일한 기능을 하는 다른 것을 사용하는 경우 이걸 쓸 필요가 없다.

### 컨테이너 런타임
컨테이너 실행을 담당하는 SW이다.

### 애드온
쿠버네티스 리소스를 사용하여 클러스터의 기능을 구현한다. 클러스터 수준의 기능을 제공하기에, 애드온의 네임스페이스 리소스는 `kube-system` 네임스페이스에 속한다.

### DNS
모든 클러스터에는 클러스터 DNS가 있어야 한다.

클러스터 DNS는 쿠버네티스 서비으세 대한 DNS 레코드를 제공하는 DNS 서버로, 기존 별도의 DNS와 다르게 동작한다.

### 웹 UI, 대시보드
클러스터를 위한 범용 웹 기반 UI이다. 클러스터 자체와 그 안의 애플리케이션을 관리할 수 있다.

### 컨테이너 리소스 모니터링
컨테이너에 대한 `시계열 메트릭`을 중앙 디비에 저장하고, 데이터 탐색을 위한 UI를 제공한다.

### 클러스터 수준 로깅
`클러스터 수준 로깅 매커니즘`은컨테이너 로그 조회 인터페이스를 갖춘 중앙 저장소 역할을 한다.

### 네트워크 플러그인
`컨테이너 네트워크 인터페이스`(CNI) 사양을 구현하는 SW 컴포넌트이다. 파드에 IP 주소를 할당하고 클러스터 안에서 서로 통신할 수 있게 해준다.

## 아키텍처 변형
쿠버네티스의 핵심 컴포넌트들은 일관성을 유지하지만, 배포/관리 방식은 달라질 수 있다.

### 컨트롤 플레인 배포 옵션

#### 전통적 배포
컨트롤 플레인 컴포넌트가 `전용 머신` 또는 `VM`에서 보통 `systemd`로 직접 실행된다.

#### 정적 파드
컨트롤 플레인 컴포넌트가 정적 파드로 배포되어 특정 노드의 kubelet으로 관리된다. `kubeadm`과 같은 도구에서 사용하는 `일반적인 방식`이다.

#### 셀프 호스팅 (self-hosted)
컨트롤 플레인이 쿱네티스 클러스터 자체 내에서 `파드로 실행`되며, 디플로이먼트나 스테이트풀셋 등의 다른 리소스에 의해 관리된다.

#### 매니지드 쿠버네티스 서비스
클라우드 공급자는 종종 컨트롤 플레인을 추상화, 자사 서비스 제공의 일부로 컴포넌트를 관리해줌. (k3s, nks??)

### 워크로드 배치 고려사항
컨트롤 플레인 컴포넌트를 포함한 워크로드 배치는 클러스터의 크기, 성능 요구, 운영 정책에 따라 달라질 수 있다.

- 작은 규모의 클러스터 또는 개발 클러스터에서는, 컨트롤 플레인 컴포넌트와 사용자 워크로드가 동일한 노드에서 실행할 수 있다.
- 큰 규모의 클러스터에서는 보통 컨트롤 플레인 노드를 전용으로 두어, 사용자 워크로드와 분리한다.

### 클러스터 관리 도구
kubeadm, kops, kubespray 같은 도구들은 클러스터를 배포 관리하는 데 다양한 접근 방식을 제공, 고유한 관리 방식을 갖는다.

### 커스터마이제이션과 확장성
- 기본 쿠버네티스 스케줄러 대신 커스텀 스케줄러 배포 가능
- API 서버는 커스텀리소스정의와 API 집계를 통해 확장 가능
- 클라우드 공급자를 통한 클라우드 서비스 통합
