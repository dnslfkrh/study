# 쿠버네티스 오브젝트 이해하기

쿠버네티스 오브젝트는 쿠버네티스 시스템에서 영속성(프로그램의 실행이 종료되어도 데이터나 객체가 사라지지 않고 유지되는 성질)을 가지는 오브젝트이다.

쿠버네티스에서는 `클러스터의 상태`를 나타내기 위해 이 오브젝트라는 것을 이용한다.

`구체적인 이용 목적`
- 어떤 컨테이너화된 애플리케이션이 동작 중인지, 어느 노드인지
- 그 애플리케이션이 어떤 리소스를 이용할 수 있는지
- 그 애플리케이션이 어떻게 재구동 정책, 업그레이드, 그리고 내고장성과 같은 것에 동작해야 하는지에 대한 정책

쿠버네티스 오브젝트는 하나의 `의도를 담은 레코드`라고 한다.

오브젝트를 생성하게 되면, 쿠버네티스 시스템은 그 오브젝트를 생성을 보장하기 위해 지속적으로 작동할 것이다.

쿠버네티스 오브젝트를 작동시키기 위해선 `쿠버네티스 API`를 사용해야 한다.

## 오브젝트 명세(spec)와 상태(status)

거의 모든 쿠버네티스 오브젝트는 `오브젝트의 구성을 결정해주는 두 개의 중첩된 오브젝트 필드`를 포함한다.

바로 `오브젝트 spec`과 `오브젝트 status`이다.

### spec을 가진 오브젝트는
오브젝트를 생성할 때 리소스에 원하는 특징(의도한 상태)에 대한 설명을 제공해서 설정한다.

### status는
쿠버네티스 시스템과 컴포넌트에 의해 `제공되고 업데이트된` 오브젝트의 `현재 상태`를 설명한다.

쿠버네티스 `컨트롤 플레인`은 모든 오브젝트의 실제 상태를 사용자가 `의도한 상태`와 일치시키기 위해 끊임없이 능동적으로 관리한다.

쿠버네티스 디플로이먼트는 클러스터에서 동잘할 애플리케이션을 표현해줄 수 있는 오브젝트이다. 디플로이먼트를 생성할 때, 디플로이먼트 spec에 3개의 애플리케이션 레플리카(개수)가 동작되도록 설정할 수 있다. 쿠버네티스 시스템은 그 디플로이먼트의 spec을 읽어 spec에 일치되도록 상태를 업데이트한다. 만약 그 인스턴스 중 하나에 문제가 생겨 `상태가 변화`한다면 쿠버네티스 시스템은 보정을 통해 `spec과 status의 차이`에 대응한다.

## 쿠버네티스 오브젝트 기술하기

대부분의 경우 정보를 `.yaml` 파일로 `kubectl` 명령(API)에 제공한다. `kubectl`은 API 요청이 이루어질 때, JSON 형식으로 변환해준다.

### 쿠버네티스 디플로이먼트를 위한 필수 필드와 오브젝트 spec을 보여주는 `.yaml` 파일 예제

`application/deployment.yaml`

```yaml
apiVersion: apps/v1    # API 그룹/버전: Deployment는 apps/v1 사용
kind: Deployment       # 리소스 종류: 클러스터에 배포(관리)할 단위
metadata:
  name: nginx-deployment   # 오브젝트 이름 (소문자/숫자/하이픈 권장)
  # labels: 메타데이터 용도로 추가 가능 (선택)
spec:
  replicas: 2              # 사용자가 원하는 파드(복제본) 수: "의도한 상태"
  selector:
    matchLabels:
      app: nginx           # 디플로이먼트가 관리할 파드를 고르기 위한 셀렉터(필수)
  template:                # 파드 템플릿: 실제 생성될 파드의 스펙
    metadata:
      labels:
        app: nginx         # 파드에 붙일 라벨(위 selector와 일치해야 함)
    spec:
      containers:
      - name: nginx        # 컨테이너 이름
        image: nginx:1.14.2 # 사용할 이미지와 태그(태그 지정 권장)
        ports:
        - containerPort: 80 # 컨테이너 내부 포트(서비스 노출과는 별개)
        # 추가 권장 항목:
        # resources:          # 리소스 요청/제한(생산 환경 권장)
        # readinessProbe:     # 준비 상태 확인(트래픽 라우팅 전)
        # livenessProbe:      # 생존 확인(비정상 시 재시작)

```

위 예시와 같이 .yaml 파일을 이용하여 디플로이먼트를 생성하기 위한 하나의 방식으로 `kubectl` 커맨드를 사용하는 것이다.

실행:
```
kubectl apply -f https://k8s.io/examples/application/deployment.yaml
```

출력:
```
deployment.apps/nginx-deployment created
```

## yaml 파일에서 요구되는 필드

`apiVersion`: 이 오브젝트를 생성하기 위해 사용되는 쿠버네티스 API 버전  
`kind`: 어떤 종류의 오브젝트를 생성하고자 하는지 (Deployment, Service ...)  
`metadata`: `이름` 문자열, `UID`, `네임스페이스(선택)`를 포함하여 오브젝트를 유일하게 구분시켜줄 데이터  
`spec`: 오브젝트에 대한 의도하는 상태